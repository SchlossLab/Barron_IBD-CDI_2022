---
date: '`r Sys.Date()`'
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: false
    includes:
      in_header: preamble.tex
  html_document:
    theme: paper
    self-contained: true
fontsize: 12pt
geometry: margin=1.0in
bibliography: references.bib
csl: msphere.csl
link-citations: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs", output_format = "all") })
---
```{r knitr_settings, eval=TRUE, echo=FALSE, cache=FALSE}
schtools::set_knitr_opts()
knitr::opts_chunk$set(message = FALSE,
                      fig.path = 'figures/',
                      dpi = 300
                      )
```

```{r deps}
library(here)
library(knitr)
library(tidyverse)
```

```{r data}
perf_dat <- read_csv(here('results','performance_results.csv'))
mean_train_auroc <- perf_dat %>% pull(cv_metric_AUC) %>% mean()
sd_train_auroc <- perf_dat %>% pull(cv_metric_AUC) %>% sd()
mean_test_auroc <- perf_dat %>% pull(AUC) %>% mean()
sd_test_auroc <- perf_dat %>% pull(AUC) %>% sd()
mean_test_auprc <- perf_dat %>% pull(prAUC) %>% mean()
sd_test_auprc <- perf_dat %>% pull(prAUC) %>% sd()


metadat <- readxl::read_excel(here("data", "raw", "ml_metadata.xlsx")) %>%
  rename(sample = group)
cdiff_tally <- metadat %>% group_by(pos_cdiff_d1) %>% tally()
npos <- cdiff_tally %>% filter(pos_cdiff_d1 == 'yes') %>% pull(n)
ntot <-cdiff_tally %>% pull(n) %>% sum()
baseline_prc <- npos / ntot
```

## Machine learning prediction of _C. difficile_ colonization based on microbiota composition on day of challenge  

Performance was measured by the area under the receiver-operator characteristic curve (AUROC) and the area under the precision-recall curve (AUPRC).

- Performance on cross-validation folds of training data:
    - Mean AUROC `r mean_train_auroc` (s.d. `r sd_train_auroc`)
- Performance on held-out test data: 
    - Mean AUROC `r mean_test_auroc` (s.d. `r sd_test_auroc`)
    - Mean AUPRC `r mean_test_auprc` (s.d. `r sd_test_auprc`)

### Feature importance: top 20 OTUs

```{r top_OTUs}
read_csv(here('results','top_20_features.csv')) %>% 
    mutate(mean_decrease = -mean_diff) %>% 
    select(label, mean_diff, sd_diff, percent_models_signif, -mean_diff) %>% 
    rename(stdev = sd_diff,
           OTU = label,
           `% models` = percent_models_signif) %>% 
    kable()
```


## Machine learning methods

TODO describe pipeline [@topcuoglu_framework_2020]

mikropml version 1.2.1 [@topcuoglu_mikropml_2021]

The workflow used to perform the machine learning analysis is available at https://github.com/SchlossLab/Barron_IBD-CDI_2022

## References

\setlength{\parindent}{-0.25in}
\setlength{\leftskip}{0.25in}
\noindent

<div id="refs"></div>

\setlength{\parindent}{0in}
\setlength{\leftskip}{0in}

\newpage

```{r fig-5-ml, out.width='100%'}
include_graphics(here(snakemake@input[['fig']]))
```

**Figure 5.** Machine learning analysis to predict _C. difficile_ colonization.
**A)** Mean area under the receiver-operator characteristic curve (AUROC) on the
cross-validation folds during model training, mean AUROC on the held-out test
data, and mean area under the precision-recall curve (AUPRC) on the held-out
test data. The dashed grey lines represent the baseline AUROC (0.5) and AUPRC
(`r baseline_prc`). 
**B)** Receiver-operator characteristic curve for the
test data. Mean specificity is plotted against sensitivity. The light green
shaded area shows the standard deviation. 
**C)** Precision-recall curve for
the test data. Mean precision is plotted against recall. The light blue shaded
area shows the standard deviation. 
**D)** Top 20 most important OTUs as
determined by permutation tests. Features with a larger decrease in AUROC when
permuted are more important. The points are the median decrease in AUROC while
the tails are the standard deviation. Color represents the percentage of models
for which the feature's permutation AUROC was significantly different from the
actual AUROC. 
**E)** Log$_{10}$ relative abundance for the top 20 most important
OTUs on day 0 of the experiment.
